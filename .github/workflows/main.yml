name: Build GKI Kernel with Lindroid DRM

on:
  workflow_dispatch:

env:
  PATCH_REPO: Linux-on-droid/lindroid-drm-loopback
  KERNEL_BRANCH: android-gs-pantah-5.10-android13-qpr3

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl python3 python3-pip bc bison build-essential flex \
          libssl-dev libncurses5-dev libncursesw5-dev rsync cpio zip dwarves device-tree-compiler

    - name: Install repo tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod +x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Repo init & sync Google kernel
      run: |
        mkdir -p google-kernel
        cd google-kernel
        repo init -u https://android.googlesource.com/kernel/manifest -b $KERNEL_BRANCH --depth=1
        repo sync --current-branch -j$(nproc) || true
        cd ..

    - name: Checkout Lindroid DRM patch
      uses: actions/checkout@v3
      with:
        repository: ${{ env.PATCH_REPO }}
        path: drm-dkms

    - name: Apply Lindroid DRM patch
      run: |
        cd google-kernel/private/gs-google
        mkdir -p drivers/lindroid-drm
        echo 'obj-y += lindroid-drm/' >> drivers/Makefile
        echo 'source "drivers/lindroid-drm/Kconfig"' >> drivers/Kconfig
        cp -r ../../../../drm-dkms/* drivers/lindroid-drm
        cd ../../../..

    - name: Build kernel with build_cloudripper.sh
      run: |
        cd google-kernel/private/gs-google
        chmod +x build_cloudripper.sh
        ./build_cloudripper.sh
        cd ../../../..

    - name: Collect build artifacts
      run: |
        mkdir -p artifacts
        cp -r google-kernel/private/gs-google/out/* artifacts/ || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gki-lindroid-build-full
        path: artifacts
