name: Sync Google Kernel

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:

      # 1️⃣ Checkout repository
      - name: Checkout repo default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Install repo tool
      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod +x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      # 3️⃣ Sync Google kernel
      - name: Repo sync Google kernel
        run: |
          BRANCH="android-gs-pantah-5.10-android13-qpr3"
          mkdir -p google-kernel
          cd google-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b $BRANCH --depth=1
          repo sync --current-branch -j$(nproc) || true
          cd ..

      # 4️⃣ Hapus folder .repo dan submodule .git internal
      - name: Remove .repo and submodule .git (safe)
        run: |
          # Hapus semua folder .repo
          find google-kernel -name ".repo" -type d -exec rm -rf {} +

          # Hapus .git hanya di submodule internal
          find google-kernel -name ".git" -type d -exec rm -rf {} +

      # 5️⃣ Commit & push ke branch default
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Copy kernel ke root repo
          rsync -a google-kernel/ ./

          git add .
          git commit -m "Update Google kernel $BRANCH" || echo "No changes to commit"
          git push origin HEAD
